<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dayi.demo.bug.dao.BugDao">

    <resultMap id="bugResultMap" type="Bug">
        <id property="id" column="id"></id>
        <result property="addTime" column="addtime"></result>
        <result property="updateTime" column="updatetime"></result>
        <result property="noProcessing" column="is_noprocessing"></result>
        <result property="bugTitle" column="bug_title"></result>
        <result property="bugContent" column="bug_content"></result>
        <result property="bugStatus" column="bug_status"></result>
        <association property="project" column="project_id" select="com.dayi.demo.project.dao.ProjectDao.getProject"/>
        <association property="bugProposer" column="bug_proposer" select="com.dayi.demo.user.dao.UserDao.getUser"/>
        <association property="bugProcesser" column="bug_processer" select="com.dayi.demo.user.dao.UserDao.getUser"/>
    </resultMap>

    <sql id="selectAllColumnBug">
        SELECT bug.id,bug.addtime,bug.updatetime,project_id,is_noprocessing,bug_title,bug_content
        ,bug_status,bug_proposer,bug_processer  FROM
    </sql>

    <!--查询项目下的bug-->
    <select id="findBugByProject" resultMap="bugResultMap">
        SELECT id,bug_title,bug_status,bug_proposer,addtime,bug_processer FROM bug
            WHERE project_id = #{projectId}
            <if test="null != begin">AND addtime >= #{begin}</if>
            <if test="null != end">AND addtime &lt;= #{end}</if>
            <if test="-1 != status">AND bug_status = #{status}</if>
            <if test="null != processerId">AND bug_processer = #{processerId}</if>
            <if test="null != proposerId">AND bug_proposer = #{proposerId}</if>
    </select>

    <!--查找用户被指派的Bug-->
    <select id="findBugByUserDesignee" resultMap="bugResultMap">
        SELECT id,bug_title,bug_status,bug_proposer,addtime,bug_processer FROM bug
            bug WHERE
            (bug_proposer = #{0} AND bug_status = 2)
            OR
            (bug_processer = #{0} AND 2 > bug_status)
    </select>

    <select id="getBug" resultMap="bugResultMap">
        <include refid="selectAllColumnBug"/>
            bug WHERE id = #{0}
    </select>

    <!--统计项目的Bug总数-->
    <select id="countBugByProject" resultType="java.util.HashMap">
      SELECT project_id AS 'projectId', COUNT(*) AS 'allBug',
          COUNT(bug_status != 3 OR NULL) AS 'bugNumber' FROM bug GROUP BY project_id
    </select>

    <!--统计每个处理者的Bug-->
    <select id="countBugByProcesser" resultType="java.util.HashMap">
      SELECT bug_processer AS 'processer',
          COUNT(*) AS 'bugNumber',
          COUNT(bug_status = 0 OR NULL) AS 'designate' ,
          COUNT(bug_status = 1 OR NULL) AS 'processing' ,
          COUNT(bug_status = 2 OR NULL) AS 'checking' ,
          COUNT(bug_status = 3 OR NULL) AS 'finished'
          FROM bug GROUP BY bug_processer
    </select>

    <!--统计每个提出者的ug-->
    <select id="countBugByProposer" resultType="java.util.HashMap">
      SELECT bug_proposer AS 'proposer',
          COUNT(*) AS 'bugNumber',
          COUNT(bug_status = 0 OR NULL) AS 'designate' ,
          COUNT(bug_status = 1 OR NULL) AS 'processing' ,
          COUNT(bug_status = 2 OR NULL) AS 'checking' ,
          COUNT(bug_status = 3 OR NULL) AS 'finished'
          FROM bug GROUP BY bug_proposer
    </select>

    <!--统计项目下未完成的Bug量-->
    <select id="countBugByProjectNoFinished" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM bug WHERE project_id = #{0} AND bug_status != 3
    </select>

    <!--添加ug-->
    <insert id="addBug">
        INSERT INTO bug (id, addtime, updatetime, project_id, is_noprocessing,
                         bug_status, bug_title, bug_content, bug_proposer, bug_processer)
        VALUES (#{id}, #{addTime}, #{updateTime}, #{project.id}, #{noProcessing}, #{bugStatus},
                #{bugTitle}, #{bugContent}, #{bugProposer.id}, #{bugProcesser.id})
    </insert>

    <!--更新Bug状态-->
    <update id="updateBugStatue">
        UPDATE bug
        <set>
            <if test="-1 != bugStatus">bug_status = #{bugStatus}, </if>
            <if test="null != bugProcesser">bug_processer = #{bugProcesser}, </if>
            <if test="null != updateTime">updatetime = #{updateTime}, </if>
            is_noprocessing = #{noProcessing}
        </set>
        WHERE id = #{id}
    </update>

</mapper>